external procedure HT2Per(Date, Date , var string);external procedure CurValToOtherCur(Date,string,val,string,var val,roundmode);external function LongInt DateDiff(Date,Date);external function roundmode DefaultRoundMode();SetLangMode(LangRussian,"RUS",0);global procedure ProfitOverPeriodRn(record RcVc RepSpec)begin	record PRVc PRr;	record TBBUVc TBBUr;	record BaseCurBlock bascur;	row TBBUVc TBBUrw;	record VIVc VIr;	record IVVc IVr;	Boolean TrHs,TrHs1,testf;	integer mtrw,i,pos,rw;	string 255 tstr,empname;	date sdate,edate,fdate,ldate;	val periodpercent,budj,bud_GP,bud_loss,VI_rloss,VI_lossSum,IV_profit,real_income,budjVAT,deb,real_VIvat,prof_percent,difffinal,budGP_percent;	val diffperiod,diffproj;	val totbud,totbudGP,totbudloss,totrealprofit,totrealloss,totrealGP;	roundmode rnd;	StartReportJob("Начисления за период");	sdate=RepSpec.sStartDate;  	edate=RepSpec.sEndDate;	rw=2;	HT2Per(sdate,edate,tstr);  	Header(rw,tstr,0);  	EndHeader;  	rw = rw + 1;		rnd = DefaultValRoundoff;  	rnd.decimals = 3;  	rnd.step = kRoundingStepNone;  	rnd.mode = kRoundingModeHalfUp;	pos = 0;	startformat(15);		outstring(0,0,"№ пр-та",false);		outstring(pos+=25,0,"Начало пр-та",false);		outstring(pos+=30,0,"Конец пр-та",false);		outstring(pos+=30,0,"% попадания в пер.",false);		outstring(pos+=35,0,"Утв.бюджет",false);		outstring(pos+=30,0,"НДС",false);		outstring(pos+=25,0,"Утв.бюджет без НДС",false);		outstring(pos+=35,0,"Бюдж.расход",false);		outstring(pos+=30,0,"Бюдж.дох-сть",false);		outstring(pos+=30,0,"Бюдж.дох-сть %",false);		outstring(pos+=30,0,"Р.доход на пер.",false);		outstring(pos+=30,0,"Р.расход на пер.",false);		outstring(pos+=30,0,"Р.дох-сть на пер.",false);		outstring(pos+=30,0,"Р.дох-сть %",false);		outstring(pos+=25,0,"Валюта пр-та",false);	endformat;		if (NonBlank(RepSpec.f1)) then begin		PRr.Code = RepSpec.f1;	end;		BlockLoad(bascur);	TrHs = true;	while (LoopMain(PRr,1,TrHs)) begin		testf = true;		if (NonBlank(RepSpec.f1) and PRr.Code!=RepSpec.f1) then begin TrHs=false; testf=false; end;		if (PRr.StartDate>edate or PRr.EndDate<sdate) then begin testf=false; end;		if (testf) then begin			if (PRr.StartDate>sdate) then begin				fdate = PRr.StartDate;			end else begin				fdate = sdate;			end;			if (PRr.EndDate<edate) then begin				ldate = PRr.EndDate;			end else begin				ldate = edate;			end;			diffperiod = DateDiff(PRr.EndDate,PRr.StartDate);			diffproj = DateDiff(ldate,fdate);  			difffinal = diffproj/diffperiod;			difffinal = Round(difffinal,rnd);			TBBUr.PRCode = PRr.Code;			ReadFirstMain(TBBUr,1,true);			budj = TBBUr.TotSumVAT;			budjVAT = TBBUr.Sum3;			bud_GP = TBBUr.GPTot;			totbud = totbud + budj;			totbudGP = totbudGP + bud_GP;			budGP_percent = TBBUr.GPTotPercent;			mtrw = MatRowCnt(TBBUr);			bud_loss = 0;			for (i=0;i<mtrw;i=i+1) begin				MatRowGet(TBBUr,i,TBBUrw);				if (nonblank(TBBUrw.SubContractor)) then begin					bud_loss = bud_loss + (TBBUrw.SumCost);				end;			end;			totbudloss = totbudloss + bud_loss;			VI_rloss = 0;			IV_profit = 0;			real_VIvat = 0;			VIr.PRCode = PRr.Code;			TrHs1 = true;			while (loopkey("PRCodeDueDate",VIr,1,TrHs1)) begin				if (VIr.PRCode!=PRr.Code) then begin TrHs1 = false; end;				if (TrHs1) then begin			  	VI_rloss = VI_rloss + VIr.PayVal;			  	if NonBlank(VIr.CalcVATVal) then begin				 		real_VIvat = real_VIvat + VIr.CalcVATVal;					end else begin						real_VIvat = real_VIvat + VIr.VATVal;					end;				end;			end; ResetLoop(VIr);			IVr.PRCode = PRr.Code;			TrHs1 = true;			while (loopkey("PRCodePayDate",IVr,1,TrHs1)) begin				if (IVr.PRCode!=PRr.Code) then begin TrHs1 = false; end;				if (TrHs1) then begin					if (IVr.CurncyCode!=bascur.BaseCur1) then begin						CurValToOtherCur(IVr.InvDate,IVr.CurncyCode,IVr.Sum4,bascur.BaseCur1,deb,DefaultCurRoundOff);					end else begin						deb = IVr.Sum4;					end;					IV_profit = IV_profit + deb;				end;			end; ResetLoop(IVr);			if (IV_profit==0) then begin				prof_percent = 0;			end else begin				prof_percent = Round(((IV_profit - VI_rloss)/IV_profit)*100*difffinal,DefaultRoundMode);			end;			IV_profit = IV_profit*difffinal;			VI_rloss = VI_rloss*difffinal;			real_VIvat = real_VIvat*difffinal;						VI_lossSum = VI_rloss - real_VIvat;			real_income = IV_profit - VI_rloss;						totrealprofit = totrealprofit + IV_profit;			totrealloss = totrealloss + VI_lossSum;			totrealGP = totrealGP + real_income;						if Blank(budj) then begin budj = 0; end;			if Blank(budjVAT) then begin budjVAT = 0; end;			if Blank(bud_GP) then begin bud_GP = 0; end;			if Blank(VI_rloss) then begin VI_rloss = 0; end;			if Blank(VI_lossSum) then begin VI_lossSum = 0; end;			if Blank(real_VIvat) then begin real_VIvat = 0; end;			if Blank(bud_GP) then begin bud_GP = 0; end;			if Blank(real_income) then begin real_income = 0; end;			pos = 0;			startformat(15);				outstring(0,"DblPRVc",PRr.Code,false);				outstring(pos+=25,0,PRr.StartDate,false);				outstring(pos+=30,0,PRr.EndDate,false);				outstring(pos+=30,0,difffinal*100,false);				outstring(pos+=35,0,budj,false);				outstring(pos+=30,0,budjVAT,false);				outstring(pos+=25,0,budj - budjVAT,false);				outstring(pos+=35,0,bud_loss,false);				outstring(pos+=30,0,bud_GP,false);				outstring(pos+=30,0,budGP_percent & " %",false);				outstring(pos+=30,0,IV_profit,false);				outstring(pos+=30,0,VI_lossSum,false);				outstring(pos+=30,0,real_income,false);				outstring(pos+=30,0,prof_percent & " %",false);				outstring(pos+=25,0,PRr.CurncyCode,false);			endformat;		end;	end;	Black_Divider(0,1);	pos = 0;	startformat(15);		outstring(0,0,"",false);		outstring(pos+=25,0,"",false);		outstring(pos+=30,0,"",false);		outstring(pos+=30,0,"",false);		outstring(pos+=35,0,totbud,false);		outstring(pos+=30,0,"",false);		outstring(pos+=25,0,"",false);		outstring(pos+=35,0,totbudloss,false);		outstring(pos+=30,0,totbudGP,false);		outstring(pos+=30,0,"",false);		outstring(pos+=30,0,totrealprofit,false);		outstring(pos+=30,0,totrealloss,false);		outstring(pos+=30,0,totrealGP,false);		outstring(pos+=30,0,"",false);		outstring(pos+=25,0,"",false);	endformat;	endjob;return;end;