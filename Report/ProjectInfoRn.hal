external procedure CurValToOtherCur(Date,string,val,string,var val,roundmode);
external function roundmode DefaultRoundMode(); //Edit***************************Sasha2,14:27 02.12.2014

SetLangMode(LangRussian,"RUS",0);


global procedure ProjectInfoRn(record RcVc RepSpec)
begin
	record PRVc PRr;
	record TBBUVc TBBUr;
	record VIVc VIr;
	record IVVc IVr;
	record IPrsVc IPrsr;
	record OPrsVc OPrsr;
	record IPVc IPr;
	row IPVc IPrw;
	record OPVc OPr;
	row OPVc OPrw;
	record ADJVc ADJr;
	record SAVc SAr;
	record ADJVIVc ADJVIr;
	record SAVIVc SAVIr;
	val VIrashod,VIsum,VIvat,dohod,budj,budjsum,budjVAT;
	val deb,cl,cred,sup;
	val totdeb,totcl,totcred,totsup;
	Boolean TrHs,TrHs2,testf,oncef;
	integer mtrw,i;
	
	startreportnoheaderjob("Информация о проекте");
	startformat(15);
		outstring(0,0,"№ проекта",false);
		outstring(50,0,"Описание",false);
		outstring(85,0,"Вид деят.",false);
		outstring(120,0,"Валюта",false);
		outstring(150,0,"Утв. бюджет",false);
		outstring(195,0,"Сумма без НДС",false);
		outstring(250,0,"НДС",false);
		outstring(280,0,"Расход",false);
		outstring(315,0,"Сумма без НДС",false);
		outstring(365,0,"НДС",false);
		outstring(400,0,"Доходность",false);
		outstring(450,0,"%",false);
	endformat;
	Gray_Divider(0,1);
  PRr.Code = RepSpec.f1;
	ReadFirstMain(PRr,1,true);
	TBBUr.PRCode = PRr.Code;
	ReadFirstMain(TBBUr,1,true)
	if NonBlank(TBBUr.TotSumVAT) then begin
		budj = TBBUr.TotSumVAT;
		budjsum = TBBUr.TotSum;
		budjVAT = TBBUr.Sum3;
		dohod = TBBUr.GPTot; //Edit***************************Sasha2,14:20 02.12.2014
	end else begin
		budj = TBBUr.TotSum;
		budjsum = TBBUr.TotSum;
		budjVAT = 0;
		dohod = TBBUr.GPTot; //Edit***************************Sasha2,14:20 02.12.2014
	end;
	VIr.PRCode = PRr.Code;
	TrHs = true;
	while (loopkey("PRCodeDueDate",VIr,1,TrHs)) begin
		if (VIr.PRCode != PRr.Code) then begin TrHs = false; end;
		if (TrHs) then begin
	  	VIrashod = VIrashod + VIr.PayVal;
	  	if NonBlank(VIr.CalcVATVal) then begin
		 		VIvat = VIvat + VIr.CalcVATVal;
			end else begin
				VIvat = VIvat + VIr.VATVal;
			end;
		end;
	end;
	VIsum = VIrashod - VIvat;
	//dohod = budj - VIrashod; //Edit***************************Sasha2,14:20 02.12.2014
	ResetLoop(VIr);
	if Blank(budj) then begin budj = 0; end;
	if Blank(budjsum) then begin budjsum = 0; end;
	if Blank(budjVAT) then begin budjVAT = 0; end;
	if Blank(VIrashod) then begin VIrashod = 0; end;
	if Blank(VIsum) then begin VIsum = 0; end;
	if Blank(VIvat) then begin VIvat = 0; end;
	if Blank(dohod) then begin dohod = 0; end;
	startformat(15);
		outstring(0,"DblPRVc",PRr.Code,false);
		outstring(50,0,PRr.Name,false);
		outstring(85,0,PRr.PRClass,false);
		outstring(120,0,PRr.CurncyCode,false);
		outstring(150,0,budj,false);
		outstring(195,0,budjsum,false);
		outstring(245,0,budjVAT,false);
		outstring(280,0,VIrashod,false);
		outstring(315,0,VIsum,false);
		outstring(365,0,VIvat,false);
		outstring(400,0,dohod,false);
		outstring(450,0,Round((dohod/budj*100),DefaultRoundMode) & " %",false);
	endformat;
	Black_Divider(0,1);
	startformat(15);
		outstring(0,0,"",false);
		outstring(50,0,"Оплата от клиента",false);
	endformat;
	Gray_Divider(45,115);
	startformat(15);
		outstring(0,0,"",false);
		outstring(50,0,"",false);
		outstring(85,0,"Клиент",false);
		outstring(135,0,"№ сч/ф",false);
		outstring(165,0,"Дебиторская задолженость",false);
		outstring(265,0,"Оплата",false);
		outstring(300,0,"Планируемая дата",false);
		outstring(365,0,"Фактическая дата",false);
		outstring(430,0,"Форма оплаты",false);
	endformat;
	Gray_Divider(0,1);
	IVr.PRCode = PRr.Code;
	TrHs = true;
	while (loopkey("PRCodePayDate",IVr,1,TrHs)) begin
		if (IVr.PRCode != PRr.Code) then begin TrHs = false; end;
		if (TrHs) then begin
			if (IVr.CurncyCode != PRr.CurncyCode) then begin
				CurValToOtherCur(IVr.InvDate,IVr.CurncyCode,IVr.Sum4,PRr.CurncyCode,deb,DefaultCurRoundOff);
			end else begin
				deb = IVr.Sum4;
			end;
			totdeb = totdeb + deb;
			startformat(15);
				outstring(0,0,"",false);
				outstring(50,0,"",false);
				outstring(85,"DblCUVc",IVr.CustCode,false);
				outstring(135,"DblIVVc",IVr.SerNr,false);
				outstring(165,0,deb,false);
			IPr.SerNr = "";
			TrHs2 = true;
			oncef = false;
			while (loopmain(IPr,1,TrHs2)) begin
				mtrw = matrowcnt(IPr);
				for (i=0;i<mtrw;i=i+1) begin
					matrowget(IPr,i,IPrw);
					if (IPrw.InvoiceNr==IVr.SerNr) then begin
						if (IPrw.RecCurncy != PRr.CurncyCode) then begin
							CurValToOtherCur(IPr.TransDate,IPrw.RecCurncy,IPrw.RecVal,PRr.CurncyCode,cl,DefaultCurRoundOff);
						end else begin
							cl = IPrw.RecVal;
						end;
						totcl = totcl + cl;
						if (oncef) then begin startformat(15); end;
							outstring(265,0,cl,false);
							outstring(300,0,IVr.PayDate,false);
							outstring(365,0,IPrw.PayDate,false);
							outstring(430,0,IPr.PayMode,false);
						oncef = true;
						endformat;
					end;
				end;
			end;
			ResetLoop(IPr);
			if (!oncef) then begin
				outstring(430,0,PRr.PayMode,false);
				endformat;
			end;
		end;
	end;
	ResetLoop(IVr);
	Gray_Divider(0,1);
	startformat(15);
		outstring(0,0,"Итого:",false);
		outstring(50,0,"",false);
		outstring(85,0,"",false);
		outstring(135,0,"",false);
		outstring(165,0,totdeb,false);
		outstring(265,0,totcl,false);
	endformat;
	Black_Divider(0,1);
	startformat(15);
		outstring(0,0,"",false);
		outstring(50,0,"Оплата подрядчикам",false);
		outstringID(150,"CreateVIProjInf","Создать сч.ф. подрядчика",false,PRr.Code);
	endformat;
	Gray_Divider(45,125);
	startformat(15);
		outstring(0,0,"",false);
		outstring(50,0,"",false);
		outstring(85,0,"Подрядчик",false);
		outstring(135,0,"№ сч/ф",false);
		outstring(165,0,"Кредиторская задолженость",false);
		outstring(265,0,"Оплата",false);
		outstring(300,0,"Планируемая дата",false);
		outstring(365,0,"Фактическая дата",false);
		outstring(430,0,"Форма оплаты",false);
	endformat;
	Gray_Divider(0,1);
	VIr.PRCode = PRr.Code;
	TrHs = true;
	while (loopkey("PRCodeDueDate",VIr,1,TrHs)) begin
		if (VIr.PRCode != PRr.Code) then begin TrHs = false; end;
		if (TrHs) then begin
			if (VIr.CurncyCode != PRr.CurncyCode) then begin
				CurValToOtherCur(VIr.InvDate,VIr.CurncyCode,VIr.PayVal,PRr.CurncyCode,cred,DefaultCurRoundOff);
			end else begin
				cred = VIr.PayVal;
			end;
			totcred = totcred + cred;
			startformat(15);
				outstring(0,0,"",false);
				outstring(50,0,"",false);
				outstring(85,"DblCUVc",VIr.VECode,false);
				outstring(135,"DblVIVc",VIr.SerNr,false);
				outstring(165,0,cred,false);
			OPr.SerNr = "";
			TrHs2 = true;
			oncef = false;
			while (loopmain(OPr,1,TrHs2)) begin
				mtrw = matrowcnt(OPr);
				for (i=0;i<mtrw;i=i+1) begin
					matrowget(OPr,i,OPrw);
					if(OPrw.VISerNr==VIr.SerNr)then begin
						if (OPrw.RecCurncy != PRr.CurncyCode) then begin
							CurValToOtherCur(OPr.TransDate,OPrw.RecCurncy,OPrw.RecVal,PRr.CurncyCode,sup,DefaultCurRoundOff);
						end else begin
							sup = OPrw.RecVal;
						end;
						totsup = totsup + sup;
						if (oncef) then begin startformat(15); end;
							outstring(265,0,sup,false);
							outstring(300,0,VIr.DueDate,false);
							outstring(365,0,OPr.RegDate,false);
							outstring(430,0,OPr.PayMode,false);
						oncef = true;
						endformat;
					end;
				end; 							
			end;
			ResetLoop(OPr);
			if (!oncef) then begin
				outstring(430,0,PRr.PayMode,false);
				endformat;
			end;
			resetloop(OPrsr);
		end;
	end;
	ResetLoop(VIr);
	Gray_Divider(0,1);
	startformat(15);
		outstring(0,0,"Итого:",false);
		outstring(50,0,"",false);
		outstring(85,0,"",false);
		outstring(135,0,"",false);
		outstring(165,0,totcred,false);
		outstring(265,0,totsup,false);
	endformat;
	Black_Divider(0,1);
	startformat(15);
		outstring(0,0,"",false);
		outstring(50,0,"Документы от клиента",false);
	endformat;
	Gray_Divider(45,130);
	startformat(15);
		outstring(0,0,"",false);
		outstring(30,0,"",false);
		outstring(85,0,"Документ",false);
		outstring(135,0,"№ док.",false);
		outstring(165,0,"Дата",false);
		outstring(265,0,"Сумма",false);
	endformat;
	Gray_Divider(0,1);
	SAr.PRCode = PRr.Code;
	TrHs = true;
	while (loopkey("PRCode",SAr,1,TrHs)) begin
		if (SAr.PRCode != PRr.Code) then begin TrHs = false; end;
		if (TrHs) then begin
			startformat(15);
				outstring(0,0,"",false);
				outstring(30,0,"",false);
				outstring(85,0,"ДС",false);
				outstring(135,0,SAr.SANum,false);
				outstring(165,0,SAr.TransDate,false);
				outstring(265,0,SAr.Sum,false);
			endformat;
		end;
	end;
	ResetLoop(SAr);
	Gray_Divider(0,1);
	ADJr.PRCode = PRr.Code;
	TrHs = true;
	while (loopkey("PRCode",ADJr,1,TrHs)) begin
		if (ADJr.PRCode != PRr.Code) then begin TrHs = false; end;
		if (TrHs) then begin
			startformat(15);
				outstring(0,0,"",false);
				outstring(30,0,"",false);
				outstring(85,0,"Акт",false);
				outstring(135,0,ADJr.ADJNum,false);
				outstring(165,0,ADJr.TransDate,false);
				outstring(265,0,ADJr.Sum,false);
			endformat;
		end;
	end;
	ResetLoop(ADJr);
	Black_Divider(0,1);
	startformat(15);
		outstring(0,0,"",false);
		outstring(50,0,"Документы от подрядчика",false);
	endformat;
	Gray_Divider(45,140);
	startformat(15);
		outstring(0,0,"",false);
		outstring(30,0,"Подрядчик",false);
		outstring(85,0,"Документ",false);
		outstring(135,0,"№ док.",false);
		outstring(165,0,"Дата",false);
		outstring(265,0,"Сумма",false);
	endformat;
	Gray_Divider(0,1);
	SAVIr.PRCode = PRr.Code;
	TrHs = true;
	while (loopkey("PRCode",SAVIr,1,TrHs)) begin
		if (SAVIr.PRCode != PRr.Code) then begin TrHs = false; end;
		if (TrHs) then begin
			startformat(15);
				outstring(0,0,"",false);
				outstring(30,0,SAVIr.VECode,false);
				outstring(85,0,"ДС",false);
				outstring(135,0,SAVIr.SANum,false);
				outstring(165,0,SAVIr.TransDate,false);
				outstring(265,0,SAVIr.Sum,false);
			endformat;
		end;
	end;
	ResetLoop(SAVIr);
	Gray_Divider(0,1);
	ADJVIr.PRCode = PRr.Code;
	TrHs = true;
	while (loopkey("PRCode",ADJVIr,1,TrHs)) begin
		if (ADJVIr.PRCode != PRr.Code) then begin TrHs = false; end;
		if (TrHs) then begin
			startformat(15);
				outstring(0,0,"",false);
				outstring(30,0,ADJVIr.VECode,false);
				outstring(85,0,"Акт",false);
				outstring(135,0,ADJVIr.ADJNum,false);
				outstring(165,0,ADJVIr.TransDate,false);
				outstring(265,0,ADJVIr.Sum,false);
			endformat;
		end;
	end;
	ResetLoop(ADJVIr);
	Black_Divider(0,1);

	endjob;
return;
end;